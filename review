#!/usr/bin/env bash
set -euo pipefail

function usage {
  cat <<EOF
review [--verbose] [--context TEXT|-] [--help] [git-diff-arguments...]

Ask an LLM to review code changes. This tool passes arguments directly to 'git diff',
allowing you to use any git diff syntax or options.

Options:
  --models LIST      Comma-separated models to run (e.g. "gpt-4o,gemini-2.0-flash")
  -c, --context TEXT  Add additional context for the review, appended to the system prompt. Will be concatenated if provided multiple times
      --context -     Read additional context from stdin
  -h, --help          Show this help message
  -v, --verbose       Enable verbose output

Review Examples:
  # Review unstaged changes
  review

  # Review with additional context
  review --context "Focus your review on possible authentication bypasses"

  # Review with context from stdin
  cat PR_DESCRIPTION.md | review --context -

  # Review with context from a command
  git log -1 --pretty=%B | review --context -

  # Review staged changes
  review --cached

  # Review changes between HEAD and main
  review main

  # Review changes between two branches
  review main feature-branch
  # OR
  review main..feature-branch

  # Review only changes since branch diverged from main
  review main...feature-branch

  # Review a remote branch
  review origin/main..origin/feature-branch

  # Limit review to specific files
  review main -- src/components/

  # Adjust context lines
  review -U5 main

Dot Notation:
  - Two dots (A..B): Direct comparison between A and B
  - Three dots (A...B): Compare common ancestor of A and B with B

Depends on:
- llm: https://github.com/simonw/llm
- bat: https://github.com/sharkdp/bat (optional)
EOF
  exit "${1:-0}"
}

git_args=()
has_unified_context=false
context_value=10
additional_context=""

# Allow multiple models via flag or env
models_arg="${LLM_MODELS:-}"   # e.g. export LLM_MODELS="gpt-4o,gemini-2.0-flash"
models_list=()

# Process only our custom arguments, pass everything else to git
while [[ $# -gt 0 ]]; do
  case "$1" in
    -v|--verbose)
      set -x
      shift
      ;;
    --models)
      shift
      if [[ $# -gt 0 ]]; then
        models_arg="$1"
        shift
      else
        error "Missing value for --models (expected comma-separated list)"
      fi
      ;;
    -c|--context)
      shift
      if [[ $# -gt 0 ]]; then
        # Read from stdin for context
        if [[ "$1" == "-" ]]; then
          if [[ -t 0 ]]; then
            error "No stdin input available for --context -"
          fi
          new_context=$(cat)
          if [[ -z "$new_context" ]]; then
            error "Empty input from stdin for --context -"
          fi
        else
          new_context=$1
        fi
        if [[ -n "$additional_context" ]]; then
          additional_context="${additional_context}

$new_context"
        else
          additional_context="$new_context"
        fi
        shift
      else
        error "Missing value for --context option"
      fi
      ;;
    -U[0-9]*)
      # Form: -U10
      has_unified_context=true
      context_value="${1#-U}"
      git_args+=("$1")
      shift
      ;;
    -U)
      # Form: -U 10
      has_unified_context=true
      shift
      if [[ $# -gt 0 && "$1" =~ ^[0-9]+$ ]]; then
        context_value="$1"
        # normalize to `-U10` to ease our checking later on
        git_args+=("-U$1")
        shift
      else
        error "Missing value for -U option"
      fi
      ;;
    --unified=*)
      # Form: --unified=10
      has_unified_context=true
      context_value="${1#--unified=}"
      git_args+=("$1")
      shift
      ;;
    -h|--help)
      usage
      ;;
    *)
      # Store all other arguments to pass to git diff
      git_args+=("$1")
      shift
      ;;
  esac
done

# Split models list after parsing
if [[ -n "$models_arg" ]]; then
  IFS=',' read -r -a models_list <<< "$models_arg"
fi

readonly RED='\033[0;31m'
readonly BLUE='\033[0;34m'
readonly RESET='\033[0m'

info() {
  printf "${BLUE}• %s${RESET}\n" "$1" >&2
}

error() {
  printf "${RED}❌ %s${RESET}\n" "$1" >&2
  usage 1
}

if ! command -v llm >/dev/null 2>&1; then
  error "Missing required command llm. On mac: brew install llm"
fi

# Default unified context if none specified.
if [[ "$has_unified_context" == false ]]; then
  git_args=("-U$context_value" "${git_args[@]}")
fi

# Run git diff
diff_output=$(git diff "${git_args[@]}" 2>/dev/null || error "Git diff command failed. Check your arguments.")

if [[ -z "$diff_output" ]]; then
  error "No changes found to review."
fi

# Token estimation to avoid huge diffs
max_tokens=50000
chars_per_token=4
char_count=${#diff_output}
estimated_tokens=$((char_count / chars_per_token))

if [[ $estimated_tokens -gt $max_tokens ]]; then
  reduced_context=$((context_value * max_tokens / estimated_tokens))
  reduced_context=$((reduced_context > 0 ? reduced_context : 1))
  info "Reducing context to $reduced_context lines to fit token limits"

  new_git_args=()
  for arg in "${git_args[@]}"; do
    if [[ "$arg" =~ ^-U[0-9]+$ ]]; then
      new_git_args+=("-U$reduced_context")
    elif [[ "$arg" =~ ^--unified=[0-9]+$ ]]; then
      new_git_args+=("--unified=$reduced_context")
    else
      new_git_args+=("$arg")
    fi
  done

  if [[ $((${#diff_output} / chars_per_token)) -gt max_tokens ]]; then
    error "Diff is too large to process even with minimal context. Try reviewing a smaller set of changes."
  fi

  diff_output=$(git diff "${new_git_args[@]}" 2>/dev/null || error "Git diff command failed with reduced context.")
fi

prompt="Please review this PR as if you were a senior engineer.

First, assign a 3-star readiness rating for whether this is ready to hand to a human reviewer:

- ★★★ Ready for human review: coherent changes; no obvious correctness/security/build risks; tests/docs updated where needed; only minor nits remain.
- ★★☆ Needs minor fixes first: mostly good, but a few clear, quick fixes would waste a reviewer’s time (e.g., missing/incorrect tests, small logic issue, lint/doc nits). No major redesign required.
- ★☆☆ Not ready: significant risks or gaps—likely breakages, incomplete feature, missing migrations/rollbacks, security concerns, large untested refactor, TODOs/commented-out code, unclear intent.

Heuristics to weigh: correctness risk, tests for changed behavior, security & data implications, scope/clarity (diff size vs. explanation), operational impact (deps/migrations/feature flags), documentation and changelog notes, and maintainability.

Focus areas:
- Architecture and design decisions
- Potential bugs and edge cases
- Performance considerations
- Security implications
- Code maintainability and best practices
- Test coverage

Produce a concise, actionable review in this exact format:

# Readiness: <one of ★☆☆, ★★☆, ★★★> — <short reason>

## Why this rating (1–3 bullets)
- <reason>
- <reason>

## Blocking before human review
- [ ] <blocking item>
- [ ] <blocking item>

## Non-blocking suggestions
- <suggestion>
- <suggestion>

## Test plan gaps
- <gap>
- <gap>

Be specific. Point to files/lines from the diff when useful. Prefer small code snippets over vague advice. Keep it tight."

# Add the additional context if provided
if [[ -n "$additional_context" ]]; then
  prompt="$prompt

## Additional Context
$additional_context"
fi

# Helper to run one model
run_for_model() {
  local model="$1"
  if command -v bat >/dev/null 2>&1; then
    printf "## %s\n\n" "$model" | bat --paging=never --style=plain --language=markdown
    echo "$diff_output" | llm -s "$prompt" -m "$model" | bat --paging=never --style=plain --language=markdown
  else
    printf "## %s\n\n" "$model"
    echo "$diff_output" | llm -s "$prompt" -m "$model"
  fi
}

exit_status=0

if [[ ${#models_list[@]} -gt 0 ]]; then
  for model in "${models_list[@]}"; do
    run_for_model "$model" || exit_status=1
    echo -e "\n---\n"
  done
else
  if [[ -n "${LLM_MODEL:-}" ]]; then
    if command -v bat >/dev/null 2>&1; then
      echo "$diff_output" | llm -s "$prompt" -m "$LLM_MODEL" | bat --paging=never --style=plain --language=markdown
    else
      echo "$diff_output" | llm -s "$prompt" -m "$LLM_MODEL"
    fi
  else
    if command -v bat >/dev/null 2>&1; then
      echo "$diff_output" | llm -s "$prompt" | bat --paging=never --style=plain --language=markdown
    else
      echo "$diff_output" | llm -s "$prompt"
    fi
  fi
  exit_status=${PIPESTATUS[1]:-0}
fi

if [[ "$exit_status" -eq 130 ]]; then
  exit 130
elif [[ "$exit_status" -ne 0 ]]; then
  echo "Error: LLM command failed." >&2
  exit 1
fi
